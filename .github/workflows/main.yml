name: Build and Deploy ASP.NET WebForms to IIS

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Show workspace for debugging
      - name: Show workspace
        shell: powershell
        run: |
          Write-Host "GITHUB_WORKSPACE = $env:GITHUB_WORKSPACE"
          dir $env:GITHUB_WORKSPACE

      # 3️⃣ Restore NuGet packages
      - name: Restore NuGet packages
        shell: powershell
        run: |
          $nuget = "C:\actions-runner\nuget.exe"
          & $nuget restore "$env:GITHUB_WORKSPACE\GadgetsOnlineWebForms.sln"

      # 4️⃣ Build solution using correct MSBuild path
      - name: Build solution
        shell: powershell
        run: |
          $msbuildPath = "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe"
          & $msbuildPath "$env:GITHUB_WORKSPACE\GadgetsOnlineWebForms.sln" `
            /p:Configuration=Release `
            /p:Platform="Any CPU"
  
      - name: Deploy to IIS
        shell: powershell
        run: |
          # Correct path: project folder inside solution
          $source = "$env:GITHUB_WORKSPACE\GadgetsOnlineWebForms\GadgetsOnlineWebForms\bin\Release"
          $destination = "C:\inetpub\wwwroot\GadgetsOnlineWebForms"

          if (!(Test-Path $destination)) {
            New-Item -ItemType Directory -Path $destination
          }

          Copy-Item "$source\*" $destination -Recurse -Force
