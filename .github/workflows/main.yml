name: Deploy WebForms to IIS (Windows EC2)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, windows]

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Build & Deploy WebForms to IIS
      shell: powershell
      run: |
        $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\amd64\MSBuild.exe"
        $project = "GadgetsOnlineWebForms\GadgetsOnlineWebForms.csproj"
        $deployPath = "C:\inetpub\wwwroot\GadgetsOnlineWebForms"

        if (!(Test-Path $msbuild)) {
          Write-Error "MSBuild not found"
          exit 1
        }

        Write-Output "Using MSBuild: $msbuild"

        & "$msbuild" "$project" `
          /p:Configuration=Release `
          /p:RestorePackages=true `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:PublishUrl="$deployPath" `
          /p:DeleteExistingFiles=false

        Write-Output "âœ… Build & deployment completed"

    - name: Verify IIS files
      shell: powershell
      run: |
        Get-ChildItem "C:\inetpub\wwwroot\GadgetsOnlineWebForms" -Recurse | Select-Object -First 20
