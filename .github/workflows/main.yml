name: Deploy WebForms to IIS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows]

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Restore NuGet packages (FIXED)
      - name: Restore NuGet packages
        shell: powershell
        run: |
          & "C:\Users\Administrator\Downloads\nuget.exe" restore `
            "C:\actions-runner\_work\LegacyDotNetWebForms\LegacyDotNetWebForms.sln"

      # 3️⃣ Build solution
      - name: Build solution
        shell: powershell
        run: |
          $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\amd64\MSBuild.exe"
          & $msbuild `
            "C:\actions-runner\_work\LegacyDotNetWebForms\LegacyDotNetWebForms.sln" `
            /p:Configuration=Release `
            /p:DeployOnBuild=true

      # 4️⃣ Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "C:\actions-runner\_work\LegacyDotNetWebForms\LegacyDotNetWebForms\GadgetsOnlineWebForms\bin\Release"
          $destination = "C:\inetpub\wwwroot\GadgetsOnlineWebForms"

          if (!(Test-Path $destination)) {
            New-Item -ItemType Directory -Path $destination | Out-Null
          }

          Copy-Item "$source\*" $destination -Recurse -Force

      # 5️⃣ Restart IIS site
      - name: Restart IIS Website
        shell: powershell
        run: |
          Import-Module WebAdministration
          if ((Get-Website -Name "GadgetsOnlineWebForms").State -eq "Started") {
            Stop-Website -Name "GadgetsOnlineWebForms"
          }
          Start-Website -Name "GadgetsOnlineWebForms"
