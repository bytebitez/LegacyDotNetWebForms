name: Deploy WebForms to IIS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows]

    steps:
      # 1️⃣ Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Debug workspace (KEEP for now – very useful)
      - name: Debug workspace
        shell: powershell
        run: |
          Write-Host "GITHUB_WORKSPACE = $env:GITHUB_WORKSPACE"
          Get-ChildItem $env:GITHUB_WORKSPACE

      # 3️⃣ Restore NuGet packages
      - name: Restore NuGet packages
        shell: powershell
        run: |
          & "C:\actions-runner\nuget.exe" restore `
            "$env:GITHUB_WORKSPACE\LegacyDotNetWebForms.sln"

      # 4️⃣ Build solution using MSBuild
      - name: Build solution
        shell: powershell
        run: |
          $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\amd64\MSBuild.exe"
          & $msbuild `
            "$env:GITHUB_WORKSPACE\LegacyDotNetWebForms.sln" `
            /p:Configuration=Release `
            /p:DeployOnBuild=true

      # 5️⃣ Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "$env:GITHUB_WORKSPACE\GadgetsOnlineWebForms\bin\Release"
          $destination = "C:\inetpub\wwwroot\GadgetsOnlineWebForms"

          if (!(Test-Path $destination)) {
            New-Item -ItemType Directory -Path $destination | Out-Null
          }

          Copy-Item "$source\*" $destination -Recurse -Force

      # 6️⃣ Restart IIS Website
      - name: Restart IIS Website
        shell: powershell
        run: |
          Import-Module WebAdministration
          Stop-Website -Name "GadgetsOnlineWebForms" -ErrorAction SilentlyContinue
          Start-Website -Name "GadgetsOnlineWebForms"
