name: Deploy WebForms to IIS

on:
  push:
    branches:
      - main
  workflow_dispatch: # allows manual trigger

jobs:
  build-and-deploy:
    runs-on: [self-hosted, windows]
    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Restore NuGet packages
      - name: Restore NuGet packages
        run: |
          nuget restore "LegacyDotNetWebForms.sln"
        shell: pwsh

      # 3️⃣ Build the solution using MSBuild
      - name: Build solution
        run: |
          $msbuild = "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\amd64\MSBuild.exe"
          & $msbuild "LegacyDotNetWebForms.sln" /p:Configuration=Release
        shell: pwsh

      # 4️⃣ Copy files to IIS site
      - name: Deploy to IIS
        run: |
          $source = "C:\actions-runner\_work\LegacyDotNetWebForms\LegacyDotNetWebForms\GadgetsOnlineWebForms\bin\Release"
          $destination = "C:\inetpub\wwwroot\GadgetsOnlineWebForms" # change if your site is different
          
          # Ensure destination exists
          if (!(Test-Path $destination)) {
              New-Item -ItemType Directory -Path $destination
          }

          # Copy files
          Copy-Item -Path "$source\*" -Destination $destination -Recurse -Force
        shell: pwsh

      # 5️⃣ Optional: restart IIS site (if needed)
      - name: Restart IIS site
        run: |
          Import-Module WebAdministration
          Stop-Website -Name "GadgetsOnlineWebForms"
          Start-Website -Name "GadgetsOnlineWebForms"
        shell: pwsh
