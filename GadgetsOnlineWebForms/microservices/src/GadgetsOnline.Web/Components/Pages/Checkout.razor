@page "/checkout"
@using GadgetsOnline.Shared.Contracts
@using GadgetsOnline.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IOrderService OrderService
@inject NavigationManager Navigation
@inject ILogger<Checkout> Logger
@rendermode InteractiveServer

<PageTitle>Checkout - Gadgets Online</PageTitle>

<h2>Address And Payment</h2>

<EditForm Model="@orderRequest" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    <fieldset>
        <legend>Shipping Information</legend>

        <div class="mb-3">
            <label for="FirstName" class="form-label">First Name</label>
            <InputText class="form-control" id="FirstName" @bind-Value="orderRequest.FirstName" />
            <ValidationMessage For="@(() => orderRequest.FirstName)" />
        </div>

        <div class="mb-3">
            <label for="LastName" class="form-label">Last Name</label>
            <InputText class="form-control" id="LastName" @bind-Value="orderRequest.LastName" />
            <ValidationMessage For="@(() => orderRequest.LastName)" />
        </div>

        <div class="mb-3">
            <label for="Address" class="form-label">Address</label>
            <InputText class="form-control" id="Address" @bind-Value="orderRequest.Address" />
            <ValidationMessage For="@(() => orderRequest.Address)" />
        </div>

        <div class="mb-3">
            <label for="City" class="form-label">City</label>
            <InputText class="form-control" id="City" @bind-Value="orderRequest.City" />
            <ValidationMessage For="@(() => orderRequest.City)" />
        </div>

        <div class="mb-3">
            <label for="State" class="form-label">State</label>
            <InputText class="form-control" id="State" @bind-Value="orderRequest.State" />
            <ValidationMessage For="@(() => orderRequest.State)" />
        </div>

        <div class="mb-3">
            <label for="PostalCode" class="form-label">Postal Code</label>
            <InputText class="form-control" id="PostalCode" @bind-Value="orderRequest.PostalCode" />
            <ValidationMessage For="@(() => orderRequest.PostalCode)" />
        </div>

        <div class="mb-3">
            <label for="Country" class="form-label">Country</label>
            <InputText class="form-control" id="Country" @bind-Value="orderRequest.Country" />
            <ValidationMessage For="@(() => orderRequest.Country)" />
        </div>

        <div class="mb-3">
            <label for="Phone" class="form-label">Phone</label>
            <InputText class="form-control" id="Phone" @bind-Value="orderRequest.Phone" />
            <ValidationMessage For="@(() => orderRequest.Phone)" />
        </div>

        <div class="mb-3">
            <label for="Email" class="form-label">Email Address</label>
            <InputText class="form-control" id="Email" @bind-Value="orderRequest.Email" />
            <ValidationMessage For="@(() => orderRequest.Email)" />
        </div>
    </fieldset>

    <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
        @if (isSubmitting)
        {
            <span>Processing...</span>
        }
        else
        {
            <span>Submit Order</span>
        }
    </button>
</EditForm>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-3">@errorMessage</div>
}

@code {
    [SupplyParameterFromQuery]
    public string? CartId { get; set; }

    private CreateOrderRequest orderRequest = new();
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(CartId))
        {
            CartId = "user-cart-" + Guid.NewGuid().ToString().Substring(0, 8);
        }
        
        orderRequest.CartId = CartId;
        orderRequest.Username = "Anonymous";
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        errorMessage = string.Empty;
        
        try
        {
            var orderId = await OrderService.CreateOrderAsync(orderRequest);
            Logger.LogInformation("Order {OrderId} created successfully", orderId);
            Navigation.NavigateTo($"/order-complete/{orderId}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating order");
            errorMessage = "Error processing your order. Please try again.";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
