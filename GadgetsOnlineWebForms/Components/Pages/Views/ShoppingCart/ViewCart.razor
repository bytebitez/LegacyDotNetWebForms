@namespace GadgetsOnlineWebForms.Components.Pages.Views.ShoppingCart.ViewCart

@page "/Views/ShoppingCart/ViewCart"
@rendermode InteractiveServer
@using GadgetsOnline.Services
@using GadgetsOnlineWebForms.ViewModels
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager NavigationManager
@inject ILogger<ViewCart> Logger

<h3>
    <em>Review</em> your cart:
</h3>
<p class="button">
    <NavLink href="/Views/Checkout/AddressAndPayment">Checkout >></NavLink>
</p>
<div id="update-message">
    @updateMessage
</div>
<table>
    <tr>
        <th>
            Product
        </th>
        <th>
            Price (each)
        </th>
        <th>
            Quantity
        </th>
        <th></th>
    </tr>
    @if (Model != null && Model.CartItems != null)
    {
        @foreach (var item in Model.CartItems)
        {
            var productUrl = "/Views/Store/Details?productId=" + item.ProductId;
            <tr id="row-@item.RecordId">
                <td>
                    <NavLink href="@productUrl">"@item.Product.Name"</NavLink>
                </td>
                <td>
                    @item.Product.Price
                </td>
                <td id="item-count-@item.RecordId">
                    @item.Count
                </td>
                <td>
                    <button @onclick="() => RemoveFromCart(item.ProductId)" class="RemoveLink">Remove from cart</button>
                </td>
            </tr>
        }
    }
    <tr>
        <td>
            Total
        </td>
        <td>
        </td>
        <td>
        </td>
        <td id="cart-total">
            @(Model?.CartTotal ?? 0)
        </td>
    </tr>
</table>

@code {
    protected ShoppingCartViewModel Model;
    private string updateMessage = string.Empty;
    private const string CartSessionKey = "CartId";

    protected override void OnInitialized()
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            int productId = 0;
            if (Int32.TryParse(query["addToCart"], out productId))
            {
                AddToCart(productId);
            }
            else if (Int32.TryParse(query["removeFromCart"], out productId))
            {
                RemoveFromCartFromQuery(productId);
            }

            var cart = GetCart();
            // Set up our ViewModel
            Model = new ShoppingCartViewModel 
            { 
                CartItems = cart.GetCartItems(), 
                CartTotal = cart.GetTotal() 
            };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing ViewCart");
            Model = new ShoppingCartViewModel 
            { 
                CartItems = new List<GadgetsOnline.Models.Cart>(), 
                CartTotal = 0 
            };
        }
    }

    public void AddToCart(int id)
    {
        try
        {
            var cart = GetCart();
            cart.AddToCart(id);
            
            // Refresh the cart
            Model = new ShoppingCartViewModel 
            { 
                CartItems = cart.GetCartItems(), 
                CartTotal = cart.GetTotal() 
            };
            
            Logger.LogInformation($"Added product {id} to cart");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error adding product {id} to cart");
        }
    }

    public void RemoveFromCart(int id)
    {
        try
        {
            var cart = GetCart();
            int itemCount = cart.RemoveFromCart(id);
            var inventory = new Inventory();
            var productName = inventory.GetProductNameById(id);
            
            // Display the confirmation message
            updateMessage = System.Net.WebUtility.HtmlEncode(productName) + " has been removed from your shopping cart.";
            
            // Refresh the cart
            Model = new ShoppingCartViewModel 
            { 
                CartItems = cart.GetCartItems(), 
                CartTotal = cart.GetTotal() 
            };
            
            Logger.LogInformation($"Removed product {id} from cart. Item count: {itemCount}");
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error removing product {id} from cart");
        }
    }

    public void RemoveFromCartFromQuery(int id)
    {
        try
        {
            var cart = GetCart();
            int itemCount = cart.RemoveFromCart(id);
            var inventory = new Inventory();
            var productName = inventory.GetProductNameById(id);
            
            // Display the confirmation message
            var results = new ShoppingCartRemoveViewModel 
            { 
                Message = System.Net.WebUtility.HtmlEncode(productName) + " has been removed from your shopping cart.", 
                CartTotal = cart.GetTotal(), 
                CartCount = cart.GetCount(), 
                ItemCount = itemCount, 
                DeleteId = id 
            };
            
            Logger.LogInformation($"Removed product {id} from cart via query string. Item count: {itemCount}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error removing product {id} from cart via query string");
        }
    }

    private GadgetsOnline.Services.ShoppingCart GetCart()
    {
        var cart = new GadgetsOnline.Services.ShoppingCart();
        cart.ShoppingCartId = GetCartId();
        return cart;
    }

    private string GetCartId()
    {
        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext == null)
        {
            Logger.LogWarning("HttpContext is null in GetCartId");
            return Guid.NewGuid().ToString();
        }

        if (httpContext.Session.GetString(CartSessionKey) == null)
        {
            if (!string.IsNullOrWhiteSpace(httpContext.User?.Identity?.Name))
            {
                httpContext.Session.SetString(CartSessionKey, httpContext.User.Identity.Name);
            }
            else
            {
                // Generate a new random GUID using System.Guid class
                Guid tempCartId = Guid.NewGuid();

                // Send tempCartId back to client as a cookie
                httpContext.Session.SetString(CartSessionKey, tempCartId.ToString());
            }
        }

        return httpContext.Session.GetString(CartSessionKey);
    }
}