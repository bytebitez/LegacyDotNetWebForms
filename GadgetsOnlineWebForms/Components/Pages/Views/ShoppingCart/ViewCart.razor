@namespace GadgetsOnlineWebForms.Components.Pages.Views.ShoppingCart.ViewCart

@page "/Views/ShoppingCart/ViewCart"
@rendermode InteractiveServer
@using GadgetsOnline.Services
@using GadgetsOnlineWebForms.ViewModels
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager NavigationManager
@inject ILogger<ViewCart> Logger

<h3>
    <em>Review</em> your cart:
</h3>
<p class="button">
    <NavLink href="/Views/Checkout/AddressAndPayment">Checkout >></NavLink>
</p>
<div id="update-message">
    @updateMessage
</div>
<table>
    <tr>
        <th>
            Product
        </th>
        <th>
            Price (each)
        </th>
        <th>
            Quantity
        </th>
        <th></th>
    </tr>
    @if (Model != null && Model.CartItems != null)
    {
        @foreach (var item in Model.CartItems)
        {
            var productUrl = "/Views/Store/Details?productId=" + item.ProductId;
            <tr id="row-@item.RecordId">
                <td>
                    <NavLink href="@productUrl">"@item.Product.Name"</NavLink>
                </td>
                <td>
                    @item.Product.Price
                </td>
                <td id="item-count-@item.RecordId">
                    @item.Count
                </td>
                <td>
                    <button @onclick="() => RemoveFromCartClick(item.ProductId)" class="RemoveLink" style="background:none; border:none; color:blue; text-decoration:underline; cursor:pointer;">Remove from cart</button>
                </td>
            </tr>
        }
    }
    <tr>
        <td>
            Total
        </td>
        <td>
        </td>
        <td>
        </td>
        <td id="cart-total">
            @(Model?.CartTotal ?? 0)
        </td>
    </tr>
</table>

@code {
    protected ShoppingCartViewModel Model;
    private string updateMessage = string.Empty;
    private const string CartSessionKey = "CartId";
    private string _cartId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Initialize cart ID first
            await InitializeCartId();
            
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            
            int productId = 0;
            if (Int32.TryParse(query["addToCart"], out productId))
            {
                AddToCart(productId);
            }
            else if (Int32.TryParse(query["removeFromCart"], out productId))
            {
                RemoveFromCart(productId);
            }

            var cart = GetCart();
            // Set up our ViewModel
            Model = new ShoppingCartViewModel 
            { 
                CartItems = cart.GetCartItems(), 
                CartTotal = cart.GetTotal() 
            };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing ViewCart");
            Model = new ShoppingCartViewModel 
            { 
                CartItems = new List<GadgetsOnline.Models.Cart>(), 
                CartTotal = 0 
            };
        }
    }

    private async Task InitializeCartId()
    {
        var httpContext = HttpContextAccessor.HttpContext;
        
        if (httpContext != null)
        {
            _cartId = httpContext.Session.GetString(CartSessionKey);
            
            if (string.IsNullOrEmpty(_cartId))
            {
                if (!string.IsNullOrWhiteSpace(httpContext.User?.Identity?.Name))
                {
                    _cartId = httpContext.User.Identity.Name;
                }
                else
                {
                    _cartId = Guid.NewGuid().ToString();
                }
                
                // Try to set session, but don't fail if we can't
                try
                {
                    httpContext.Session.SetString(CartSessionKey, _cartId);
                }
                catch (InvalidOperationException)
                {
                    // Session cannot be established after response has started
                    // This is expected in Blazor Server, we'll use the generated ID
                    Logger.LogWarning("Could not set session after response started, using temporary cart ID");
                }
            }
        }
        else
        {
            _cartId = Guid.NewGuid().ToString();
        }
    }

    public void AddToCart(int id)
    {
        try
        {
            var cart = GetCart();
            cart.AddToCart(id);
            Logger.LogInformation($"Product {id} added to cart");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error adding product {id} to cart");
        }
    }

    public void RemoveFromCart(int id)
    {
        try
        {
            var cart = GetCart();
            int itemCount = cart.RemoveFromCart(id);
            var inventory = new Inventory();
            var productName = inventory.GetProductNameById(id);
            
            // Display the confirmation message
            updateMessage = System.Web.HttpUtility.HtmlEncode(productName) + " has been removed from your shopping cart.";
            
            var results = new ShoppingCartRemoveViewModel 
            { 
                Message = updateMessage,
                CartTotal = cart.GetTotal(), 
                CartCount = cart.GetCount(), 
                ItemCount = itemCount, 
                DeleteId = id 
            };
            
            Logger.LogInformation($"Product {id} removed from cart");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error removing product {id} from cart");
        }
    }

    private void RemoveFromCartClick(int productId)
    {
        RemoveFromCart(productId);
        
        // Refresh the cart
        var cart = GetCart();
        Model = new ShoppingCartViewModel 
        { 
            CartItems = cart.GetCartItems(), 
            CartTotal = cart.GetTotal() 
        };
        
        StateHasChanged();
    }

    private GadgetsOnline.Services.ShoppingCart GetCart()
    {
        var cart = new GadgetsOnline.Services.ShoppingCart();
        cart.ShoppingCartId = GetCartId();
        return cart;
    }

    private string GetCartId()
    {
        return _cartId ?? Guid.NewGuid().ToString();
    }
}