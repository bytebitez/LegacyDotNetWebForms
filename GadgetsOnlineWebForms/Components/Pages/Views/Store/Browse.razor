@namespace GadgetsOnlineWebForms.Components.Pages.Views.Store.Browse

@page "/Views/Store/Browse"
@rendermode InteractiveServer
@using GadgetsOnline.Models
@using GadgetsOnline.Services
@using Microsoft.AspNetCore.Components
@implements IDisposable
@inject ILogger<Browse> Logger
@inject NavigationManager NavigationManager

<div class="genre">
    <h3>@CategoryName</h3>
    <ul id="album-list">
        @if (Products != null && Products.Any())
        {
            @foreach (var product in Products)
            {
                string productUrl = $"/Views/Store/Details?productId={product.ProductId}";
                <li>
                    <NavLink href="@productUrl">
                        <img alt="@product.Name" src="@product.ProductArtUrl" />
                        <span>@product.Name</span>
                    </NavLink>
                </li>
            }
        }
        else
        {
            <li>No products found in this category.</li>
        }
    </ul>
</div>

@code {
    private List<Product> Products = new List<Product>();
    private string CategoryName = string.Empty;

    protected override void OnInitialized()
    {
        LoadProducts();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        LoadProducts();
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        LoadProducts();
        StateHasChanged();
    }

    private void LoadProducts()
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            string categoryIdStr = query["categoryId"];

            int categoryId = 0;
            if (!Int32.TryParse(categoryIdStr, out categoryId))
            {
                Logger.LogWarning("Invalid categoryId parameter");
                Products = new List<Product>();
                return;
            }

            var inventory = new Inventory();
            Products = inventory.GetAllProductsInCategory(categoryId);
            
            // Get category name
            var categories = inventory.GetAllCategories();
            var category = categories?.FirstOrDefault(c => c.CategoryId == categoryId);
            CategoryName = category?.Name ?? "Products";

            if (Products == null)
            {
                Logger.LogWarning("No products found for categoryId: {CategoryId}", categoryId);
                Products = new List<Product>();
                return;
            }

            Logger.LogInformation("Loaded {Count} products for categoryId: {CategoryId}", Products.Count, categoryId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading products in Browse page");
            Products = new List<Product>();
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}