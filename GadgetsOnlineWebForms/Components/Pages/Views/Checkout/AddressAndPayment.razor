@namespace GadgetsOnlineWebForms.Components.Pages.Views.Checkout.AddressAndPayment

@page "/Views/Checkout/AddressAndPayment"
@rendermode InteractiveServer
@using GadgetsOnline.Models
@using GadgetsOnline.Services
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject ILogger<AddressAndPayment> Logger
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor

<h2>Address And Payment</h2>

<EditForm Model="@order" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    <fieldset>
        <legend>Shipping Information</legend>

        <div class="editor-label"><label for="FirstName">First Name</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="FirstName" @bind-Value="order.FirstName" />
            <ValidationMessage For="@(() => order.FirstName)" />
        </div>

        <div class="editor-label"><label for="LastName">Last Name</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="LastName" @bind-Value="order.LastName" />
            <ValidationMessage For="@(() => order.LastName)" />
        </div>

        <div class="editor-label"><label for="Address">Address</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="Address" @bind-Value="order.Address" />
            <ValidationMessage For="@(() => order.Address)" />
        </div>

        <div class="editor-label"><label for="City">City</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="City" @bind-Value="order.City" />
            <ValidationMessage For="@(() => order.City)" />
        </div>

        <div class="editor-label"><label for="State">State</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="State" @bind-Value="order.State" />
            <ValidationMessage For="@(() => order.State)" />
        </div>

        <div class="editor-label"><label for="PostalCode">Postal Code</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="PostalCode" @bind-Value="order.PostalCode" />
            <ValidationMessage For="@(() => order.PostalCode)" />
        </div>

        <div class="editor-label"><label for="Country">Country</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="Country" @bind-Value="order.Country" />
            <ValidationMessage For="@(() => order.Country)" />
        </div>

        <div class="editor-label"><label for="Phone">Phone</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="Phone" @bind-Value="order.Phone" />
            <ValidationMessage For="@(() => order.Phone)" />
        </div>

        <div class="editor-label"><label for="Email">Email Address</label></div>
        <div class="editor-field">
            <InputText class="text-box single-line" id="Email" @bind-Value="order.Email" />
            <ValidationMessage For="@(() => order.Email)" />
        </div>
    </fieldset>

    <fieldset>
        <legend>Payment</legend>
        <p>We're running a promotion: all music is free with the promo code: "FREE"</p>
    </fieldset>

    <button type="submit" class="button">Submit Order</button>
</EditForm>

@code {
    private Order order { get; set; } = new Order();

    private OrderProcessing? orderProcessing;

    protected override void OnInitialized()
    {
        // Initialize with empty values to ensure properties are not null
        order = new Order
        {
            FirstName = string.Empty,
            LastName = string.Empty,
            Address = string.Empty,
            City = string.Empty,
            State = string.Empty,
            PostalCode = string.Empty,
            Country = string.Empty,
            Phone = string.Empty,
            Email = string.Empty,
            Username = string.Empty
        };
        
        Logger.LogInformation("AddressAndPayment page initialized");
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            order.Username = "Anonymous";
            order.OrderDate = DateTime.Now;

            var httpContext = HttpContextAccessor.HttpContext;
            if (httpContext != null)
            {
                var cart = GetCart(httpContext);
                bool result = GetOrderProcess().ProcessOrder(order, cart);
                
                Logger.LogInformation("Order processed successfully. OrderId: {OrderId}", order.OrderId);
                NavigationManager.NavigateTo($"/Views/Checkout/Complete?orderId={order.OrderId}", true);
            }
            else
            {
                Logger.LogError("HttpContext is null");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error processing order");
            // Invalid - redisplay with errors
        }
    }

    private OrderProcessing GetOrderProcess()
    {
        if (this.orderProcessing == null)
        {
            this.orderProcessing = new OrderProcessing();
        }

        return this.orderProcessing;
    }

    private GadgetsOnline.Services.ShoppingCart GetCart(HttpContext context)
    {
        var cart = new GadgetsOnline.Services.ShoppingCart();
        cart.ShoppingCartId = GetCartId(context);
        return cart;
    }

    private const string CartSessionKey = "CartId";

    private string GetCartId(HttpContext context)
    {
        if (context.Session.GetString(CartSessionKey) == null)
        {
            if (!string.IsNullOrWhiteSpace(context.User.Identity?.Name))
            {
                context.Session.SetString(CartSessionKey, context.User.Identity.Name);
            }
            else
            {
                // Generate a new random GUID using System.Guid class
                Guid tempCartId = Guid.NewGuid();

                // Send tempCartId back to client as a cookie
                context.Session.SetString(CartSessionKey, tempCartId.ToString());
            }
        }

        return context.Session.GetString(CartSessionKey) ?? string.Empty;
    }
}